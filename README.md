# ZTNA Simulator

A comprehensive Zero Trust Network Access (ZTNA) simulator with OpenVPN integration, continuous authentication, risk-based access control, and location-aware security policies.

## Features

- ğŸ” **Authentication Server**: JWT-based authentication with role-based access control
- ğŸ›¡ï¸ **Policy Engine**: Comprehensive risk-based policies with continuous authentication
- ğŸŒ **VPN Gateway**: OpenVPN integration with automatic fallback to mock mode
- ğŸ“ **Location Detection**: IP geolocation for geo-fencing and risk assessment
- ğŸ”„ **Continuous Authentication**: Periodic verification during active sessions
- ğŸ“Š **Risk Scoring**: Multi-factor risk assessment (location, device, behavior, time)
- ğŸš¨ **Anomaly Detection**: Behavioral analytics and anomaly tracking

## Quick Start

### Automated Installation

```bash
# Clone the repository
git clone <your-repo-url>
cd ztna-simulator

# Run installation script (creates venv, installs dependencies, generates certificates)
chmod +x install.sh
./install.sh
```

The installation script will:
- âœ… Create Python virtual environment
- âœ… Install all dependencies
- âœ… Generate OpenVPN certificates automatically
- âœ… Verify setup

### Manual Installation

If you prefer manual setup:

```bash
# 1. Create virtual environment
python3 -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate

# 2. Install dependencies
pip install -r requirements.txt

# 3. Generate certificates (see Certificate Generation section)
```

## Running the System

### Start All Services

Open **3 terminal windows**:

**Terminal 1 - Auth Server (Port 5000):**
```bash
source venv/bin/activate
python auth_server.py
```

**Terminal 2 - VPN Gateway (Port 5001):**
```bash
source venv/bin/activate
python vpn_gateway.py
```

**Terminal 3 - Policy Engine (Port 5002):**
```bash
source venv/bin/activate
python policy_engine.py
```

### Verify Setup

```bash
source venv/bin/activate
python test_openvpn_setup.py
```

## Usage

### Basic Workflow

```bash
# Activate virtual environment
source venv/bin/activate

# Login
python ztna_client.py login alice@company.com:password123

# Check access
python ztna_client.py check-access file-server

# Request VPN
python ztna_client.py request-vpn

# Connect VPN
python ztna_client.py connect-vpn

# Check VPN status
python ztna_client.py vpn-status

# Disconnect
python ztna_client.py disconnect-vpn
```

### Test Users

- **Alice** (Developer, Clearance 3): `alice@company.com` / `password123`
- **Bob** (Admin, Clearance 5): `bob@company.com` / `securepass`
- **Charlie** (Analyst, Clearance 2): `charlie@company.com` / `userpass`

## Certificate Generation

Certificates are automatically generated by `install.sh`. If you need to regenerate them manually:

```bash
# The install.sh script handles this, but if needed:
openssl req -x509 -newkey rsa:2048 -keyout ca.key -out ca.crt -days 3650 -nodes \
    -subj "/C=US/ST=CA/L=SanFrancisco/O=ZTNA/OU=IT/CN=ZTNA-CA"

# Generate server certificate
openssl genrsa -out server.key 2048
openssl req -new -key server.key -out server.csr \
    -subj "/C=US/ST=CA/L=SanFrancisco/O=ZTNA/OU=Server/CN=server"
openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial \
    -out server.crt -days 3650

# Generate client certificate
openssl genrsa -out client.key 2048
openssl req -new -key client.key -out client.csr \
    -subj "/C=US/ST=CA/L=SanFrancisco/O=ZTNA/OU=Client/CN=client"
openssl x509 -req -in client.csr -CA ca.crt -CAkey ca.key -CAcreateserial \
    -out client.crt -days 3650

# Generate DH parameters
openssl dhparam -out dh2048.pem 2048
```

## OpenVPN Setup

### Option 1: Automatic (Recommended)
The VPN gateway automatically detects and starts OpenVPN. If OpenVPN can't start, it falls back to mock mode (perfect for testing).

### Option 2: Manual Start
If you want to start OpenVPN manually:

```bash
sudo openvpn --config server.ovpn --daemon
```

The VPN gateway will detect the running daemon automatically.

### Installation
- **macOS**: `brew install openvpn`
- **Ubuntu/Debian**: `sudo apt-get install openvpn`
- **CentOS/RHEL**: `sudo yum install openvpn`

**Note**: OpenVPN is optional. The system works perfectly in mock mode for testing.

## Testing

See `TEST_COMMANDS.md` for comprehensive testing guide.

Quick test:
```bash
source venv/bin/activate
python test_openvpn_setup.py
```

## API Endpoints

### Auth Server (Port 5000)
- `POST /api/auth/login` - User login
- `GET /api/auth/verify` - Verify token
- `POST /api/access/check` - Check resource access
- `POST /api/access/request-vpn` - Request VPN token

### VPN Gateway (Port 5001)
- `POST /api/vpn/connect` - Connect to VPN
- `POST /api/vpn/disconnect` - Disconnect VPN
- `POST /api/vpn/status` - Get VPN status
- `GET /api/vpn/connections` - List all connections

### Policy Engine (Port 5002)
- `POST /api/policy/evaluate` - Evaluate access policy
- `POST /api/policy/continuous-auth` - Continuous authentication
- `POST /api/policy/session-status` - Get session status
- `POST /api/policy/anomaly-detect` - Detect anomalies
- `GET /api/policy/location-detect` - Detect location from IP
- `GET /api/policy/policies` - Get policy configuration

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Client    â”‚â”€â”€â”€â”€â–¶â”‚ Auth Server  â”‚â”€â”€â”€â”€â–¶â”‚ VPN Gateway â”‚
â”‚             â”‚     â”‚  (Port 5000) â”‚     â”‚ (Port 5001) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚                     â”‚
                            â”‚                     â”‚
                            â–¼                     â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Policy     â”‚     â”‚  OpenVPN    â”‚
                    â”‚   Engine     â”‚     â”‚   Server    â”‚
                    â”‚ (Port 5002)  â”‚     â”‚  (Port 1194)â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Security Features

- âœ… JWT token authentication
- âœ… Role-based access control (RBAC)
- âœ… Risk-based access control
- âœ… Continuous authentication
- âœ… Location-aware policies
- âœ… Device compliance checks
- âœ… Behavioral anomaly detection
- âœ… Geo-fencing
- âœ… Time-based access control
- âœ… Session management

## Documentation

- `POLICY_ENGINE_DOCS.md` - Policy engine documentation
- `IP_DETECTION_FIX.md` - IP detection implementation details
- `OPENVPN_SETUP_VERIFICATION.md` - OpenVPN setup guide
- `IMPLEMENTATION_SUMMARY.md` - Implementation details
- `TEST_COMMANDS.md` - Complete testing guide

## Requirements

- Python 3.8+
- OpenSSL (for certificate generation)
- OpenVPN (optional, system works in mock mode)

## Dependencies

See `requirements.txt`:
- Flask 3.0.0
- Flask-CORS 6.0.1
- PyJWT 2.8.0
- Requests 2.31.0
- Cryptography 41.0.7

## Troubleshooting

### Port Already in Use
```bash
# Check what's using the port
lsof -i :5000
lsof -i :5001
lsof -i :5002

# Kill process if needed
kill -9 <PID>
```

### OpenVPN Issues
- System automatically falls back to mock mode
- Check `openvpn-status.log` for errors
- Verify certificates exist: `ls -la *.crt *.key *.pem`

### Certificate Issues
- Regenerate certificates: `./install.sh` (will prompt to regenerate)
- Verify certificates: `openssl x509 -in ca.crt -text -noout`

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Test thoroughly
5. Submit a pull request

## License

[Your License Here]

## Authors

[Your Name/Team]

---

**Note**: This is a simulator for educational/research purposes. For production use, implement additional security measures and follow security best practices.

